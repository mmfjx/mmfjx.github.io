# CDN理解

## 一、CDN是什么？

   CDN：内容分发网络（Content delivery network  或者 Content distribution network ）

   - 一种通过互联网相互连接的电脑网络系统
   - 利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。

## 二、为什么需要CDN
 > 根本上的原因是，访问速度对互联网应用的用户体验、口碑、甚至说直接的营收都有巨大的影响，任何的企业都渴望自己站点有更快的访问速度。而HTTP传输时延对web的访问速度的影响很大，在绝大多数情况下是起决定性作用的，这是由TCP/IP协议的一些特点决定的。物理层上的原因是光速有限、信道有限，协议上的原因有丢包、慢启动、拥塞控制等。

 > 要提高访问速度，最简单的做法当然就是多设置几个服务器，让终端用户离服务器“更近”。典型的例子是各类下载网站在不同地域不同运营商设置镜像站，或者是像Google那样设置多个数据中心。但是多设几个服务器的问题也不少，一是多地部署时的困难，二是一致性没法保障，三则是管理困难、成本很高。实际上，在排除多地容灾等特殊需求的情况下，对大多数公司这种做法是不太可取的。当然，这种方案真正做好了，甚至是比后续所说的使用CDN要好的。

> CDN是一种公共服务，他本身有很多台位于不同地域、接入不同运营商的服务器，而所谓的使用CDN实质上就是让CDN作为网站的门面，用户访问到的是CDN服务器，而不是直接访问到网站。由于CDN内部对TCP的优化、对静态资源的缓存、预取，加上用户访问CDN时，会被智能地分配到最近的节点，降低大量延迟，让访问速度可以得到很大提升。

参考文章：<https://github.com/renaesop/blog/issues/1>

## 三、CDN的原理
### 3.1 内容分发过程

> CDN做了两件事，一是让用户访问最近的节点，二是从缓存或者源站获取资源

**源站：** 提供内容的站点(网站的真实服务器), 从源站取内容的过程叫做回源。

通过中心服务器来分析不同区域部署的边缘服务器和与用户的关系，通过一定的负载均衡策略和缓存技术，将用户请求重定向到距离用户最近，并能快速提供服务的边缘服务器上

以最普通的CDN为例：
![以最普通的CDN为例](https://cloud.githubusercontent.com/assets/5894477/22008791/4edc00b0-dcb9-11e6-9663-ed19a3fa3182.png)

> 用户在首次访问 https://assets-cdn.github.com/pinned-octocat.svg , 假设不委托local DNS服务器递归查询，会经历以下几个过程:

>1.浏览器检查本地有没有这个东东的有效缓存，有则使用缓存，没有有效缓存则进行对assets-cdn.github.com的DNS查询，获得一个 CNAME记录, igithub.map.fastly.net,值得注意的是，多个加速域名可以解析到同一个CNAME，CDN回源和缓存的时候考虑到了hostname；(常规方式域名解析得到CNAME(指向cdn服务智能DNS)
访问CNAME指向地址，智能DNS解析得到对应资源的IP
访问获得的IP。)

> 2.<mark>进行对github.map.fastly.net的DNS查询，获得一个A/AAAA记录，给出地址103.245.222.133（视网站不同返回的不一样，可以有多个）, 这一步对CDN来说时十分重要的，它给出了离用户最近的边缘节点；</mark>

> 3.浏览器选一个返回的地址，然后进行真正的http请求，开始向103.245.222.133握手，握手完了把http请求头也发给了该边缘服务器;

> 4.<mark>边缘服务器检查自己的cache里面有没有https://assets-cdn.github.com/pinned-octocat.svg这个资源，有则返回给用户，如果没有，向CDN中心服务器发起请求;</mark>

> 5.<mark>CDN中心服务器检查自己的cache里面有没有这个资源，有则返回给边缘服务器，没有则回源;

> 6.<mark>中心服务器发现客户配置了github.map.fastly.net的回源地址(这个只有cdn会知道，假设是xxx.xxx.xxx.xxx)，就把http请求发到源站地址上，源站返回后返回给请求方;

>可以看出CDN加速的原理很大部分是跟DNS挂钩在一起的，CDN供应商几乎一定需要一个智能DNS服务器。CDN可以拿到所有的明文数据，所以对数据安全性、保密性要求比较高的企业会选择自建CDN或者设置NS记录，指向自建的智能DNS服务器。

><mark>上述步骤每一步都可以缓存，注意是每一步！ 所以CDN要清除缓存很难，因为有很多服务器上的缓存要清除。无论是用户对边缘服务器的请求，还是CDN服务器的回源都可以使用https。

>注意，实际环境中图中每个服务器都可以是集群，甚至CDN分区域中心和总中心。


![域名解析流程](http://verywhy.com//?qa=blob&qa_blobid=8690637679288155366)
步骤总结：

 1. 从浏览器发出请求
 2. DNS解析域名，返回离用户最近的边缘节点的服务器地址
 3. 浏览器接受返回的地址，然后进行http请求，
 4. 边缘服务器检查是否存在该资源的缓存，有则返回用户，无则向CDN中心服务器发起请求
 5. CDN中心服务器检查自己的cache里面有没有这个资源，有则返回给边缘服务器，没有则回源;
 6. 回源地址可理解为源站服务器的地址，CDN中心服务器需要回源时，可根据发布方配置的回源地址向源站服务器发起http请求

### 3.2 关键技术名词解释

#### 3.2.1 负载均衡技术
分为两种：本地负载均衡、全局负载均衡

**本地负载均衡：**通过一些方法将数据处理任务均衡的分配给服务器集群内的所有空闲可用服务器。该类技术的使用可以方便CDN系统进行后期扩展，提高现有资源的利用率，同时也可以避免因单点失效造成的损失。
本地负载均衡技术的两个重要组成部分为：用户请求重定向、负载均衡算法。

**全局负载均衡:**主要用于包含多个站点的系统，用来完成同一系统中分布在不同地域的服务器节点间的任务调配。GSLB在CDN系统中作为核心的流量调度系统，保证客户可以从系统中离自己最近的最优服务节点获得所需资源，确保访问质量。通过一些负载均衡设备如Radware WSD负载均衡器定制所需监测参数和负载均衡策略可以实现基本的CDN负载均衡任务。

用户请求重定向方式分为：正向代理和反向代理

#### 3.2.2 正反向代理
**正向代理：**正向代理是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须设置正向代理服务器，当然前提是要知道正向代理服务器的IP地址，还有代理程序的端口。
正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。
![正向代理](https://timgsa.baidu.com/timg?image&quality=80%20&size=b10000_10000&sec=1505917243314&di=22542bd53232c995a70b4ea0c3602b0e&imgtype=jpg&src=http%3A%2F%2Ff.hiphotos.baidu.com%2Fimage%2Fpic%2Fitem%2Fbf096b63f6246b6021c39763e0f81a4c500fa2d3.jpg)

**反向代理：**反向代理服务器对用户来说就像原始服务器，用户向反向代理发出内容请求，反向代理服务器通过内部网络的防火墙向原始服务器递交请求，并将得到的数据返回给客户端。
反向代理正好与正向代理相反，对于客户端而言代理服务器就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端。
![反向代理](https://timgsa.baidu.com/timg?image&quality=80%20&size=b10000_10000&sec=1505917645718&di=41fde905fd2424e02efa0baab2e31c81&imgtype=jpg&src=http%3A%2F%2Fd.hiphotos.baidu.com%2Fimage%2Fpic%2Fitem%2F241f95cad1c8a786528e6b196c09c93d70cf5004.jpg)

反向代理的用途：

   1. 保护和隐藏原始资源服务器
   ![用途1](https://pic1.zhimg.com/v2-77c945d935b61f773977631988c224d4_b.jpg)
   2. 负载均衡
  ![用途2](https://pic3.zhimg.com/v2-d30d47a79033fe44dcea4b8ade1b9ede_b.jpg)

**正反向代理区别:**

 ![正反向代理区别](http://images2015.cnblogs.com/blog/305504/201611/305504-20161112130135639-1005446770.png)

从用途上来讲：
正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是将 防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。
另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。
从安全性 来讲：
正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。
反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。

 参考文献：<http://bbs.51cto.com/thread-967852-1-1.html>
 <https://wiki.sankuai.com/pages/viewpage.action?pageId=971321139>
 <https://zhuanlan.zhihu.com/p/25423394>

### 3.3 CDN缓存与浏览器缓存

**CDN缓存:**
CDN系统中对内容的存储分为两种情况。一般来说CDN中大规模的源内容采用分布式存储。而存储缓存内容时，一般是根据一定的缓存策略将某个地区用户经常访问的热点内容预存在离用户最近的边缘节点中。内容缓存技术在解决带宽问题，增加用户访问命中率上起了很大作用，是CDN系统中一项重要技术。

在CDN系统中每个边缘服务器的存储空间是有限的。在进行资源缓存时可以采用整体缓存或者前缀、后缀缓存等分块缓存。一般来说，随着时间推移，缓存内容的热度将呈现出明显的变化，为了提高存储空间的利用效率，系统需要对缓存内容进行周期性的替换，保证缓存内容一直是热度较高的资源。

主流的缓存替换算法主要有：最近最少使用算法(LRU)，先进先出算法(FIFO)、最少使用替换算法(LFU)

**前端应用-静态内容分发:**
浏览器缓存始终只是为了提升二次访问的速度，对于首次访问的加速，最常见的手段就是CDN，某个区域的首个用户访问该区域的CDN节点后，内容就会缓存到该节点，当下一个用户首次方式时就可以访问到缓存的内容

参考文献：<https://wiki.sankuai.com/pages/viewpage.action?pageId=971321139#CDN概述-前端应用-静态内容分发>